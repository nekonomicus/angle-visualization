<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced Winkelvisualisierung mit Oval</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
      padding: 10px;
      background-color: #f8f9fa;
      max-width: 960px;
      margin: 0 auto;
    }
    #visualization {
      text-align: center;
      margin-top: 20px;
    }
    svg {
      border: 2px solid #495057;
      margin-bottom: 20px;
      background-color: #fff;
      border-radius: 10px;
      max-width: 100%;
      height: auto;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      touch-action: none; /* Improves touch handling */
    }
    .dashboard {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 20px;
    }
    .control-group {
      background-color: #e9ecef;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .control-group h3 {
      margin-top: 0;
      color: #495057;
      font-size: 1rem;
      margin-bottom: 10px;
      border-bottom: 1px solid #ced4da;
      padding-bottom: 5px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
    }
    .control-item {
      display: flex;
      align-items: center;
      margin: 5px;
    }
    label {
      font-size: 14px;
      font-weight: bold;
      margin-right: 8px;
      color: #495057;
      min-width: 120px;
    }
    input[type="number"] {
      width: 70px;
      text-align: center;
      font-size: 14px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      padding: 6px;
    }
    input[type="range"] {
      width: 150px;
    }
    .btn-group {
      display: flex;
      gap: 5px;
    }
    button {
      font-size: 14px;
      padding: 6px 12px;
      cursor: pointer;
      background-color: #6c757d;
      color: white;
      border: none;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #5a6268;
    }
    button.primary {
      background-color: #4361ee;
    }
    button.primary:hover {
      background-color: #3a56d4;
    }
    .info-panel {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
    }
    .info-item {
      background-color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      font-weight: bold;
      min-width: 180px;
      text-align: center;
    }
    .info-item.highlight {
      background-color: #e6f2ff;
    }
    .draggable-handle {
      cursor: move;
      fill-opacity: 0.2;
    }
    .draggable-handle:hover {
      fill-opacity: 0.4;
    }
    .help-text {
      font-size: 14px;
      color: #6c757d;
      margin-top: 10px;
      text-align: center;
    }
    text {
      font-size: 0.15px;
      font-weight: bold;
      fill: #343a40;
    }
    .angle-display {
      font-size: 0.12px;
      font-weight: bold;
    }
    /* Responsive styling for smaller screens */
    @media (max-width: 768px) {
      .control-item {
        width: 100%;
        flex-direction: column;
        align-items: flex-start;
      }
      label {
        margin-bottom: 5px;
      }
      input[type="range"] {
        width: 100%;
      }
      .info-item {
        width: 100%;
      }
    }
    @media (max-width: 480px) {
      body {
        padding: 5px;
      }
      .btn-group button {
        padding: 8px;
        font-size: 12px;
      }
      input[type="number"] {
        width: 60px;
      }
    }
  </style>
</head>
<body>
  <div id="visualization">
    <svg width="600" height="600" viewBox="-2.5 -2.5 5 5" id="angle-svg">
      <defs>
        <marker id="arrow-blue" markerWidth="10" markerHeight="10" refX="6" refY="3" orient="auto">
          <path d="M0,0 L0,6 L9,3 z" fill="#4361ee" />
        </marker>
        <marker id="arrow-red" markerWidth="10" markerHeight="10" refX="6" refY="3" orient="auto">
          <path d="M0,0 L0,6 L9,3 z" fill="#e63946" />
        </marker>
        <marker id="arrow-orange" markerWidth="10" markerHeight="10" refX="6" refY="3" orient="auto">
          <path d="M0,0 L0,6 L9,3 z" fill="#ff9f1c" />
        </marker>
        <filter id="glow" x="-30%" y="-30%" width="160%" height="160%">
          <feGaussianBlur stdDeviation="0.05" result="blur" />
          <feComposite in="SourceGraphic" in2="blur" operator="over" />
        </filter>
        <pattern id="grid" width="0.2" height="0.2" patternUnits="userSpaceOnUse">
          <path d="M 0.2 0 L 0 0 L 0 0.2" fill="none" stroke="#e9ecef" stroke-width="0.01"/>
        </pattern>
      </defs>
      
      <!-- Grid background -->
      <rect x="-2.5" y="-2.5" width="5" height="5" fill="url(#grid)" opacity="0.6"/>
      
      <!-- Fixed oval (solid) -->
      <ellipse cx="0" cy="0" rx="1.4" ry="0.9" stroke="#495057" fill="none" stroke-width="0.03"/>
      
      <!-- Rotating group (contains the oval, red anchor, red line, and rotating spoke) -->
      <g id="rotating-group" transform="rotate(0)">
        <!-- Rotating oval (dashed) -->
        <ellipse id="rotating-oval" cx="0" cy="0" rx="1.45" ry="0.95" stroke="#6c757d" stroke-dasharray="0.1,0.05" fill="none" stroke-width="0.02"/>
        
        <!-- Red Anchor - drilled into the rotating oval -->
        <circle id="rotating-center" cx="0.7" cy="0.3" r="0.05" fill="#e63946"/>
        
        <!-- Red Line - drilled into the rotating oval -->
        <line id="red-line" x1="0.7" y1="0.3" x2="0.7" y2="-1.7" stroke="#e63946" stroke-width="0.025" marker-end="url(#arrow-red)"/>
        
        <!-- Draggable handle for red line -->
        <circle id="red-handle" cx="0.7" cy="-1.5" r="0.08" fill="#e63946" class="draggable-handle" filter="url(#glow)"/>
        
        <!-- Full diameter rotating spoke -->
        <line id="rotating-spoke" x1="-1.45" y1="0" x2="1.45" y2="0" stroke="#ff9f1c" stroke-width="0.02" marker-end="url(#arrow-orange)"/>
      </g>
      
      <!-- Center point marker -->
      <circle cx="0" cy="0" r="0.04" fill="#212529" stroke="none"/>
      
      <!-- Blue Anchor -->
      <circle id="blue-anchor" cx="1.4" cy="0" r="0.05" fill="#4361ee"/>
      
      <!-- Fixed spoke -->
      <line id="fixed-spoke" x1="-1.4" y1="0" x2="1.4" y2="0" stroke="#ff9f1c" stroke-width="0.02" marker-end="url(#arrow-orange)"/>
      
      <!-- Blue Line -->
      <line id="blue-line" x1="1.4" y1="0" x2="1.4" y2="-2" stroke="#4361ee" stroke-width="0.025" marker-end="url(#arrow-blue)"/>
      
      <!-- Draggable handle for blue line -->
      <circle id="blue-handle" cx="1.4" cy="-1.8" r="0.08" fill="#4361ee" class="draggable-handle" filter="url(#glow)"/>
      
      <!-- Angle arc between orange spokes -->
      <path id="spoke-angle-arc" d="M 0.3 0 A 0.3 0.3 0 0 1 0.3 0" stroke="#ff9f1c" stroke-width="0.03" fill="none" fill-opacity="0.1"/>
      
      <!-- Angle arc between blue and red arrows -->
      <path id="arrow-angle-arc" d="M 0.5 -0.3 A 0.3 0.3 0 0 1 0.5 -0.3" stroke="#7209b7" stroke-width="0.03" fill="none" fill-opacity="0.1"/>
      
      <!-- Labels with better positioning -->
      <g id="info-labels" transform="translate(-2.25, 2.3)">
        <text id="angle-label" class="angle-display" y="0" fill="#7209b7">Winkel Blau-Rot: 45°</text>
        <text id="turning-label" class="angle-display" y="-0.25" fill="#ff9f1c">Drehwinkel: 0°</text>
        <text id="spoke-angle-label" class="angle-display" y="-0.5" fill="#ff9f1c">Speichenwinkel: 0°</text>
        <text id="oval-dimensions" class="angle-display" y="-0.75" fill="#495057">Oval: 1.40 × 0.90</text>
      </g>
      
      <text id="parallel-message" x="0" y="-1.4" fill="#2a9d8f" text-anchor="middle" font-size="0.18"></text>
      
      <!-- Small angle labels near the arcs -->
      <text id="spoke-angle-value" x="0.28" y="0.25" fill="#ff9f1c" font-size="0.12" text-anchor="middle">0°</text>
      <text id="arrow-angle-value" x="0.68" y="-0.35" fill="#7209b7" font-size="0.12" text-anchor="middle">45°</text>
      
      <!-- Red Angle Label -->
      <text id="red-angle-value" x="0.9" y="-1.5" fill="#e63946" font-size="0.12" text-anchor="start">90°</text>
    </svg>
  </div>
  
  <div class="help-text">
    <p>Tip: Ziehen Sie die blauen und roten Pfeilspitzen, um die Winkel direkt anzupassen</p>
  </div>

  <div class="info-panel">
    <div class="info-item highlight">
      <span id="angle-display">Winkel Blau-Rot: 45.0°</span>
    </div>
    <div class="info-item">
      <span id="turning-display">Drehwinkel: 0.0°</span>
    </div>
    <div class="info-item">
      <span id="red-angle-display">Rot-Pfeil: 90.0°</span>
    </div>
    <div class="info-item">
      <span id="oval-display">Oval: 1.40 × 0.90</span>
    </div>
  </div>

  <div class="dashboard">
    <div class="control-group">
      <h3>Grundeinstellungen</h3>
      <div class="controls">
        <div class="control-item">
          <label>Blauer Anker:</label>
          <input type="number" id="blue-anchor-pos" min="0" max="1" step="0.01" value="1">
          <input type="range" id="blue-anchor-pos-slider" min="0" max="1" step="0.01" value="1">
          <div class="btn-group">
            <button onclick="adjust('blue-anchor-pos', -0.01)">◀</button>
            <button onclick="adjust('blue-anchor-pos', 0.01)">▶</button>
          </div>
        </div>
        
        <div class="control-item">
          <label>Drehwinkel:</label>
          <input type="number" id="rot-angle" min="-180" max="180" value="0">
          <input type="range" id="rot-angle-slider" min="-180" max="180" step="1" value="0">
          <div class="btn-group">
            <button onclick="adjust('rot-angle', -1)">◀</button>
            <button onclick="adjust('rot-angle', 1)">▶</button>
          </div>
        </div>
      </div>
    </div>

    <div class="control-group">
      <h3>Roter Anker</h3>
      <div class="controls">
        <div class="control-item">
          <label>Roter Anker X:</label>
          <input type="number" id="red-anchor-x" min="-1" max="1" step="0.01" value="0.7">
          <input type="range" id="red-anchor-x-slider" min="-1" max="1" step="0.01" value="0.7">
          <div class="btn-group">
            <button onclick="adjust('red-anchor-x', -0.01)">◀</button>
            <button onclick="adjust('red-anchor-x', 0.01)">▶</button>
          </div>
        </div>
        
        <div class="control-item">
          <label>Roter Anker Y:</label>
          <input type="number" id="red-anchor-y" min="-1" max="1" step="0.01" value="0.3">
          <input type="range" id="red-anchor-y-slider" min="-1" max="1" step="0.01" value="0.3">
          <div class="btn-group">
            <button onclick="adjust('red-anchor-y', -0.01)">◀</button>
            <button onclick="adjust('red-anchor-y', 0.01)">▶</button>
          </div>
        </div>
        
        <div class="control-item">
          <label>Roter Pfeil Winkel:</label>
          <input type="number" id="init-red-angle" min="0" max="360" value="90">
          <input type="range" id="init-red-angle-slider" min="0" max="360" step="1" value="90">
          <div class="btn-group">
            <button onclick="adjust('init-red-angle', -1)">◀</button>
            <button onclick="adjust('init-red-angle', 1)">▶</button>
          </div>
        </div>
      </div>
    </div>

    <div class="control-group">
      <h3>Ovalgröße</h3>
      <div class="controls">
        <div class="control-item">
          <label>Oval Breite:</label>
          <input type="number" id="oval-width" min="0.2" max="2" step="0.05" value="1.40">
          <input type="range" id="oval-width-slider" min="0.2" max="2" step="0.05" value="1.40">
          <div class="btn-group">
            <button onclick="adjust('oval-width', -0.05)">◀</button>
            <button onclick="adjust('oval-width', 0.05)">▶</button>
          </div>
        </div>
        
        <div class="control-item">
          <label>Oval Höhe:</label>
          <input type="number" id="oval-height" min="0.2" max="2" step="0.05" value="0.90">
          <input type="range" id="oval-height-slider" min="0.2" max="2" step="0.05" value="0.90">
          <div class="btn-group">
            <button onclick="adjust('oval-height', -0.05)">◀</button>
            <button onclick="adjust('oval-height', 0.05)">▶</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Helper function to calculate SVG arc path
    function describeArc(x, y, radius, startAngle, endAngle, clockwise = false) {
      // Convert angles from degrees to radians
      const start = (startAngle * Math.PI) / 180;
      const end = (endAngle * Math.PI) / 180;
      
      // Calculate start and end points
      const startX = x + radius * Math.cos(start);
      const startY = y - radius * Math.sin(start); // Subtract for SVG coordinates (y-axis inverted)
      const endX = x + radius * Math.cos(end);
      const endY = y - radius * Math.sin(end); // Subtract for SVG coordinates (y-axis inverted)
      
      // Determine if the arc should be drawn the long way around
      let largeArcFlag = "0";
      if (clockwise) {
        // For clockwise, if end angle is less than start angle, add 360 to end
        const adjustedEnd = endAngle < startAngle ? endAngle + 360 : endAngle;
        largeArcFlag = (adjustedEnd - startAngle > 180) ? "1" : "0";
      } else {
        // For counter-clockwise, if start angle is less than end angle, add 360 to start
        const adjustedStart = startAngle < endAngle ? startAngle + 360 : startAngle;
        largeArcFlag = (adjustedStart - endAngle > 180) ? "1" : "0";
      }
      
      // Create the arc path
      // SVG parameter order: rx ry x-axis-rotation large-arc-flag sweep-flag x y
      // sweep-flag: 1 for clockwise, 0 for counterclockwise
      const sweepFlag = clockwise ? "1" : "0";
      
      const d = [
        "M", startX, startY, 
        "A", radius, radius, 0, largeArcFlag, sweepFlag, endX, endY
      ].join(" ");
      
      return d;
    }
    
    // Function to normalize an angle to 0-360 range
    function normalizeAngle(angle) {
      return ((angle % 360) + 360) % 360;
    }
    
    // Function to convert from screen to SVG coordinates
    function screenToSVGCoords(svg, event) {
      const pt = svg.createSVGPoint();
      
      // Get the touch or mouse position
      if (event.touches) {
        pt.x = event.touches[0].clientX;
        pt.y = event.touches[0].clientY;
      } else {
        pt.x = event.clientX;
        pt.y = event.clientY;
      }
      
      // Convert to SVG coordinates
      const svgP = pt.matrixTransform(svg.getScreenCTM().inverse());
      return { x: svgP.x, y: svgP.y };
    }
    
    // Function to calculate angle from center to point in degrees
    function calculateAngle(cx, cy, px, py) {
      // Calculate angle in radians (math convention, 0 = right, counterclockwise)
      const radians = Math.atan2(-(py - cy), px - cx); // Negate y because SVG y is inverted
      
      // Convert to degrees and normalize to 0-360
      let degrees = (radians * 180 / Math.PI) % 360;
      if (degrees < 0) degrees += 360;
      
      return degrees;
    }
    
    // Adjust function updated with smoother transitions
    const adjust = (id, step) => {
      const input = document.getElementById(id);
      // Update the number input value
      input.value = (parseFloat(input.value) + step).toFixed(2);
      // If a corresponding slider exists, update it too
      const slider = document.getElementById(id + '-slider');
      if (slider) {
        slider.value = input.value;
      }
      updateVisualization();
    };

    const syncInputs = (id) => {
      const numberInput = document.getElementById(id);
      const sliderInput = document.getElementById(id + '-slider');
      if (sliderInput) {
        sliderInput.value = numberInput.value;
      }
      updateVisualization();
    };

    // Attach event listeners to all inputs
    ['blue-anchor-pos', 'red-anchor-x', 'red-anchor-y', 'init-red-angle', 'rot-angle', 
     'oval-width', 'oval-height'].forEach(id => {
      document.getElementById(id).addEventListener('input', () => syncInputs(id));
      const slider = document.getElementById(id + '-slider');
      if (slider) {
        slider.addEventListener('input', () => {
          document.getElementById(id).value = slider.value;
          updateVisualization();
        });
      }
    });

    function updateVisualization() {
      // Get all values from controls
      const bPos = parseFloat(document.getElementById('blue-anchor-pos').value);
      const rBaseX = parseFloat(document.getElementById('red-anchor-x').value);
      const rBaseY = parseFloat(document.getElementById('red-anchor-y').value);
      const iAngle = parseFloat(document.getElementById('init-red-angle').value);
      const rot = parseFloat(document.getElementById('rot-angle').value);
      const ovalWidth = parseFloat(document.getElementById('oval-width').value);
      const ovalHeight = parseFloat(document.getElementById('oval-height').value);

      // Update the fixed oval dimensions
      document.querySelector('ellipse:not(#rotating-oval)').setAttribute('rx', ovalWidth);
      document.querySelector('ellipse:not(#rotating-oval)').setAttribute('ry', ovalHeight);
      
      // Update the rotating oval
      // Make it slightly larger
      document.getElementById('rotating-oval').setAttribute('rx', ovalWidth * 1.05);
      document.getElementById('rotating-oval').setAttribute('ry', ovalHeight * 1.05);
      
      // Rotate the entire group (oval + red anchor + red line + rotating spoke)
      document.getElementById('rotating-group').setAttribute('transform', `rotate(${rot})`);

      // Calculate position of blue anchor based on bPos (0 to 1)
      // bPos = 1 means it's at the right edge of the oval
      const bX = ovalWidth * bPos;
      const bY = 0; // Y-coordinate is always 0 for blue anchor
      
      // Update the position of red anchor and line within the rotating group
      // These are fixed relative to the rotating oval
      document.getElementById('rotating-center').setAttribute('cx', rBaseX);
      document.getElementById('rotating-center').setAttribute('cy', rBaseY);
      
      // Update red line, starting from the red anchor
      document.getElementById('red-line').setAttribute('x1', rBaseX);
      document.getElementById('red-line').setAttribute('y1', rBaseY);
      
      // Calculate the end point of the red line using the initial angle
      const redLineRad = iAngle * Math.PI / 180;
      const redLineLength = 2; // Length of the line
      const redLineEndX = rBaseX + redLineLength * Math.cos(redLineRad);
      const redLineEndY = rBaseY - redLineLength * Math.sin(redLineRad); // Subtract because SVG Y is inverted
      
      document.getElementById('red-line').setAttribute('x2', redLineEndX);
      document.getElementById('red-line').setAttribute('y2', redLineEndY);
      
      // Position the red handle slightly before the end to account for the arrow
      const handleOffset = 0.2; // Offset from the end to account for the arrow
      const redHandleX = rBaseX + (redLineLength - handleOffset) * Math.cos(redLineRad);
      const redHandleY = rBaseY - (redLineLength - handleOffset) * Math.sin(redLineRad);
      document.getElementById('red-handle').setAttribute('cx', redHandleX);
      document.getElementById('red-handle').setAttribute('cy', redHandleY);

      // Update blue anchor and line
      document.getElementById('blue-anchor').setAttribute('cx', bX);
      document.getElementById('blue-anchor').setAttribute('cy', bY);
      document.getElementById('blue-line').setAttribute('x1', bX);
      document.getElementById('blue-line').setAttribute('y1', bY);
      document.getElementById('blue-line').setAttribute('x2', bX);
      document.getElementById('blue-line').setAttribute('y2', -2);
      
      // Position the blue handle
      document.getElementById('blue-handle').setAttribute('cx', bX);
      document.getElementById('blue-handle').setAttribute('cy', -1.8); // Slightly above the end

      // Update the fixed spoke
      document.getElementById('fixed-spoke').setAttribute('x1', -ovalWidth);
      document.getElementById('fixed-spoke').setAttribute('y1', 0);
      document.getElementById('fixed-spoke').setAttribute('x2', ovalWidth);
      document.getElementById('fixed-spoke').setAttribute('y2', 0);
      
      // Update the rotating spoke
      // Since it's in the rotating group, it's directly horizontal
      document.getElementById('rotating-spoke').setAttribute('x1', -ovalWidth * 1.05);
      document.getElementById('rotating-spoke').setAttribute('y1', 0);
      document.getElementById('rotating-spoke').setAttribute('x2', ovalWidth * 1.05);
      document.getElementById('rotating-spoke').setAttribute('y2', 0);

      // Calculate the angle between spokes in the clock convention
      // 0° when both at 3 o'clock, increases as rotating spoke moves counterclockwise
      const spokeAngleClock = Math.abs(rot);
      
      // Create the spoke angle arc
      // Draw arc based on the rotation angle
      const spokeArcPath = describeArc(0, 0, 0.3, 0, rot, rot < 0);
      document.getElementById('spoke-angle-arc').setAttribute('d', spokeArcPath);
      
      // Calculate angles for blue and red lines
      // Blue is vertical (90° in math angle)
      const blueAngle = 90;
      // Red line rotates with the oval, so its absolute angle is its initial angle + rotation
      const redAngle = normalizeAngle(iAngle + rot);
      
      // Calculate the smaller angle between them
      let arrowAngleClock = Math.abs(blueAngle - redAngle);
      if (arrowAngleClock > 180) arrowAngleClock = 360 - arrowAngleClock;
      
      // More intelligent placement of the angle arc between blue and red
      // Find a good intermediate point between the two lines for the arc center
      const blueLength = 2; // Length of blue line
      const blueEndX = bX;
      const blueEndY = -blueLength; // End of blue line
      
      // Mid point between visible parts of the lines
      const midX = (bX + redHandleX) / 2;
      const midY = (blueEndY + redHandleY) / 2;
      
      // Create the arc for the blue-red angle
      // Determine direction of the arc
      let clockwise;
      if (redAngle > blueAngle) {
        clockwise = (redAngle - blueAngle <= 180);
      } else {
        clockwise = !(blueAngle - redAngle <= 180);
      }
      
      // Create the arc path
      const arrowArcPath = describeArc(midX, midY, 0.4, blueAngle, redAngle, clockwise);
      document.getElementById('arrow-angle-arc').setAttribute('d', arrowArcPath);
      
      // Position the angle value labels near their respective arcs
      // For the spoke angle
      if (spokeAngleClock > 3) {  // Only show if angle is significant
        // Calculate a position halfway along the arc
        const halfAngle = rot / 2;
        const halfAngleRad = halfAngle * Math.PI / 180;
        const spokeAngleLabelRadius = 0.4; // Slightly outside the arc
        const spokeAngleLabelX = spokeAngleLabelRadius * Math.cos(halfAngleRad);
        const spokeAngleLabelY = -spokeAngleLabelRadius * Math.sin(halfAngleRad);
        
        document.getElementById('spoke-angle-value').setAttribute('x', spokeAngleLabelX);
        document.getElementById('spoke-angle-value').setAttribute('y', spokeAngleLabelY);
        document.getElementById('spoke-angle-value').textContent = `${spokeAngleClock.toFixed(0)}°`;
        document.getElementById('spoke-angle-value').style.visibility = 'visible';
      } else {
        document.getElementById('spoke-angle-value').style.visibility = 'hidden';
      }
      
      // For the blue-red angle
      if (arrowAngleClock > 3) {  // Only show if angle is significant
        // Calculate a position halfway along the arc
        const halfAngle = (blueAngle + redAngle) / 2;
